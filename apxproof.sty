%%
%% This is file `apxproof.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% apxproof.dtx  (with options: `package')
%% 
%% Copyright (C) 2016 by Pierre Senellart
%% 
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%% 
%% This work has the LPPL maintenance status `maintained'.
%% 
%% The Current Maintainer of this work is Pierre Senellart
%% <pierre@senellart.com> and a version control system for this work
%% is available at http://github.com/PierreSenellart/apxproof
%% 
%% This work consists of the files apxproof.dtx and apxproof.ins
%% and the derived file apxproof.sty.
%% 
\NeedsTeXFormat{LaTeX2e}[2005/12/01]
\ProvidesPackage{apxproof}
  [2016/10/27 v1.0.0 Automatic proofs in appendix]
\RequirePackage{fancyvrb}
\RequirePackage{ifthen}
\RequirePackage{environ}
\RequirePackage{bibunits}
\@ifpackageloaded{amsthm}{}{%
  \let\proof\undefined
  \let\endproof\undefined
}
\RequirePackage{amsthm}
\RequirePackage{etoolbox}
\RequirePackage{ifmtarg}
\RequirePackage{stack}

\makeatletter
\newwrite\axp@proofsfile
\immediate\openout\axp@proofsfile=\jobname.axp
\immediate\write\axp@proofsfile{%
  \noexpand\makeatletter
  \noexpand\let\noexpand\proof\noexpand\apxold@proof
  \noexpand\let\noexpand\endproof\noexpand\endapxold@proof
  \noexpand\let\noexpand\section\noexpand\apxold@section
}
\def\FVB@VerbatimOut{%
  \@bsphack
  \begingroup
    \FV@UseKeyValues
    \FV@DefineWhiteSpace
    \def\FV@Space{\space}%
    \FV@DefineTabOut
    \def\FV@ProcessLine{\immediate\write\axp@proofsfile}%
    \let\FV@FontScanPrep\relax
    \let\@noligs\relax
    \FV@Scan}
\def\FVE@VerbatimOut{\endgroup\@esphack}

\let\apxold@proof\proof
\let\endapxold@proof\endproof

\newtoggle{apx@seenreptheorem}

\newenvironment{appendixproof}
  {%
    \axp@writesection
    \immediate\write\axp@proofsfile{%
      \noexpand\begin{apxold@proof}%
    }%
    \VerbatimOut
  }
  {%
    \endVerbatimOut
    \immediate\write\axp@proofsfile{%
      \noexpand\end{apxold@proof}%
    }%
    \noproofinappendix
  }

\renewenvironment{proof}
  {%
    \iftoggle{apx@seenreptheorem}{%
      \appendixproof
    }{%
      \apxold@proof
    }%
  }
  {%
    \iftoggle{apx@seenreptheorem}{%
      \endappendixproof
    }{%
      \endapxold@proof
    }%
  }

\def\noproofinappendix{
  \global\togglefalse{apx@seenreptheorem}%
}

\let\inlineproof\apxold@proof
\let\endinlineproof\endapxold@proof

\let\nestedproof\apxold@proof
\let\endnestedproof\endapxold@proof

\def\@getcl@ss#1.cls#2\relax{\def\@currentclass{#1}}
\def\@getclass{\expandafter\@getcl@ss\@filelist\relax}
\@getclass

\newcommand{\appendixrefname}{References for the Appendix}
\newcommand{\appendixbibliographystyle}{alpha}
\newcommand{\appendixbibliographyprelim}{%
  \ifthenelse{\equal{\@currentclass}{lipics}}{%
    \global\let\oldbiblabel\@biblabel
    \def\@biblabel{\hspace*{-2em}\small\oldbiblabel}%
  }{}
}

\AtEndDocument{%
  \clearpage\onecolumn\appendix
  \appendixbibliographyprelim
  \begin{bibunit}[\appendixbibliographystyle]%
  \immediate\closeout\axp@proofsfile\input{\jobname.axp}%
  \renewcommand{\refname}{\appendixrefname}%
  \putbib
  \end{bibunit}%
}

\let\apxold@bibliography\bibliography
\renewcommand\bibliography[1]{%
  \defaultbibliography{#1}%
  \apxold@bibliography{#1}%
}

\newcounter{axp@rpcounter}
\newcounter{axp@seccounter}

\newcommand\newtheoremrep[1]{%
  \@oparg{\axp@newtheoremrep{#1}}[]%
}
\def\axp@newtheoremrep#1[#2]#3{%
  \newtheorem*{axp@#1rp}{#3}%
  \expandafter\let\csname #1\endcsname\undefined
  \expandafter\let\csname c@#1\endcsname\undefined
  \newtheorem{#1}[#2]{#3}%
  \NewEnviron{#1rep}[1][]{%
    \addtocounter{axp@rpcounter}{1}%
    \global\toggletrue{apx@seenreptheorem}%
    \begin{#1}[##1]\label{axp@r\roman{axp@rpcounter}}\BODY\end{#1}%
    \global\expandafter\let\csname rplet\roman{axp@rpcounter}\endcsname\BODY%
    \axp@writesection%
    \immediate\write\axp@proofsfile{%
      \noexpand\begin{axp@#1rp}[\noexpand\ref{axp@r\roman{axp@rpcounter}}\@ifnotempty{##1}{\noexpand##1}]%
      \noexpand\let\noexpand\label\noexpand\@gobble%
      \expandafter\noexpand\csname rplet\roman{axp@rpcounter}\endcsname\noexpand\end{axp@#1rp}
      }
  }
}

\def\apx@sectitle{}

\let\apxold@section\section
\def\section{\@ifstar\@section\@@section}
\def\@section#1{%
  \global\edef\apx@sectitle{#1}%
  \apxold@section*{#1}%
  \addtocounter{axp@seccounter}{1}%
  \label{axp@s\roman{axp@seccounter}}%
}
\def\@@section#1{%
  \global\edef\apx@sectitle{#1}%
  \apxold@section{#1}%
  \addtocounter{axp@seccounter}{1}%
  \label{axp@s\roman{axp@seccounter}}%
}
\ifdefined\@acmtitlebox
  \def\section{\@ifstar\@section{\@dblarg{\@@section}}}
  \def\@@section[#1]#2{%
    \global\edef\apx@sectitle{#2}%
    \apxold@section{#2}%
    \addtocounter{axp@seccounter}{1}%
    \label{axp@s\roman{axp@seccounter}}%
  }
\fi

\newcommand{\nosectionappendix}{
  \global\def\apx@sectitle{}%
}

\newcommand\axp@writesection{%
  \ifx\apx@sectitle\empty
  \else
    \immediate\write\axp@proofsfile{\noexpand\def\noexpand\tmp{\noexpand\ref{axp@s\roman{axp@seccounter}}}\noexpand\apxold@section{Proofs for Section\noexpand~\noexpand\protect\noexpand\tmp{}
    (\apx@sectitle)}}%
    \nosectionappendix
  \fi
}

\newenvironment{proofsketch}
  {\vskip3pt\noindent\emph{Proof sketch.} }
  {\hfill\qed\vskip3pt}

\newenvironment{toappendix}
  {\axp@writesection\VerbatimOut}
  {\endVerbatimOut}

\ifdefined\@acmtitlebox
  \newtheoremstyle{mystyle}%
    {3pt}
    {3pt}
    {\itshape}
    {}
    {\scshape}
    {.}
    {.5em}
    {}
  \theoremstyle{mystyle}

  \newcommand{\refname}{REFERENCES}
  \patchcmd{\thebibliography}{References}{\protect\refname}{}{}
  \patchcmd{\thebibliography}{References}{\protect\refname}{}{}

  \renewcommand{\appendixrefname}{REFERENCES FOR THE APPENDIX}
\fi

\def\thmhead#1#2#3{%
  \thmname{#1}\thmnumber{\@ifnotempty{#1}{ }\@upn{#2}}%
  \thmnote{ #3}}

\makeatother
\endinput
%%
%% End of file `apxproof.sty'.
